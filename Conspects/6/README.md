# Лекция 6: AJAX

## Интернет, HTTP и AJAX

## Архитектура клиент-сервер в интернете
- **Веб-сервер** обрабатывает запросы клиентов и возвращает содержимое страницы или код ошибки.
- Пример:  
  `http://domain.com/page.html`  
  - Запрос клиента → Ответ сервера (HTML, CSS, данные или ошибка).

## Традиционная модель веб-приложения
- **Веб-браузер** отправляет HTTP-запросы на сервер, который обрабатывает данные (БД, логика) и возвращает HTML + CSS.

## Модель веб-приложения с AJAX
- **AJAX-движок** (JavaScript) отправляет асинхронные запросы к серверу, получает данные (XML, HTML, JSON) и динамически обновляет страницу без перезагрузки.
---
## Что такое AJAX?
AJAX (Asynchronous JavaScript and XML) — технология, позволяющая отправлять и получать данные с сервера асинхронно, без перезагрузки страницы.  
Основной инструмент — объект `XMLHttpRequest` (XHR).
---
## Форматы передачи данных
- **Текстовые данные**
- **JSON** (JavaScript Object Notation) — популярный формат для передачи структур данных.  
  Пример:  
  ```json
  {
    "name": "John",
    "age": 30,
    "courses": ["html", "css", "js"]
  }
  ```
- **Бинарные данные**
- **Файлы**
---
## Blob и FormData
- Blob - это объект в JavaScript, который позволяет работать с бинарными данными.
- FormData - объект JavaScript, который позволяет работать с формами и файлами.

## XMLHttpRequest
XMLHttpRequest (XHR) – это встроенный в браузер объект, который даёт возможность делать HTTP-запросы к серверу без перезагрузки страницы.
XHR поддерживает 2 режима работы:
● Синхронный
● Асинхронный

### Создание и отправка запроса
```javascript
const xhr = new XMLHttpRequest();
xhr.open('GET', '/api/data'); // Инициализация
xhr.send(); // Отправка
```

### XMLHttpRequest (слушаем ответ)
После получения ответа мы можем достать его из xhr
● status - HTTP
статус ответа
● statusText - текстовых HTTP статус ответа
● response - тело ответа

## Типы ответов
● text - строка
● arrayBuffer - ArrayBuffer бинарные данные
● blob - Blob бинарные данные
● document - XML-документ
● json - JSON (автоматически парситься)

## XMLHttpRequest (состояние запроса)
● UNSET = 0 - исходное состояние
● OPENED = 1 - вызван метод open
● HEADERS_RECEIVED = 2 - получены заголовки ответа
● LOADING = 3 - ответ в процессе передачи
● DONE = 4 - запрос завершен

## CORS (Cross-Origin Resource Sharing)
### Политика одинакового источника (Same Origin Policy)
Запрещает кросс-доменные запросы, если домен, протокол или порт отличаются.

## Обратный прокси-сервер для CORS
● Одно из решений - отправляем запросы на напрямую в вебсервис, а проксируем через наш сервер фронтенда
● Похоже на prod решение при проксировании через Nginx
● Будем применять на курсе РИП

## Same Origin Policy (типы взаимодействия с ресурсами)
● Запись в ресурсы - переходы по ссылкам, редиректы, сабмит форм
● Встраивание ресурсов в другие ресурсы - добавление JavaScript,
CSS, Images и тд с помощью HTML тегов
● Чтение из других ресурсов - чтение ответов на запросы, получение
доступа к содержимому встроенного ресурса
● Cross Origin “Запись” - обычно разрешена
● Cross Origin “Встраивание” - обычно разрешено
● Cross Origin “Чтение” - по-умолчанию запрещено
Cross-Origin Resource Sharing (CORS) standard — спецификация, позволяющая обойти
ограничения, которые Same Origin Policy накладывает на кросс-доменные запросы

## CORS (браузер)
Браузер играет роль доверенного посредника:
● Он гарантирует, что к запросу на другой источник добавляется
правильный заголовок Origin.
● Он проверяет наличие разрешающего заголовка Access-ControlAllow-Origin в ответе и, если всё хорошо, то JavaScript получает
доступ к ответу сервера, в противном случае – доступ запрещается
с ошибкой.

## Типы запросов:
- **Простые**: GET, POST, HEAD с ограниченными заголовками.
- **Непростые**: Требуют предварительного OPTIONS-запроса (preflight).
---
## Хранение данных на клиенте
● Кеш браузера - сохраняет только ответы на запросы  
● Cookies - подходит для хранения сессий, имеет маленький размер  
● Web Storage API - механизм хранения key/value значений (localStorage)  
● WebSQL/IndexedDB - база данных в браузере  
---

## Куки
● Ку́ки (cookie, букв. — «печенье») — небольшой фрагмент данных, установленный и отправленный веб-сервером. Хранимый на компьютере пользователя.  
● Веб-клиент (обычно веб-браузер) всякий раз при попытке открыть страницу соответствующего сайта пересылает этот фрагмент данных веб-серверу в составе HTTP-запроса.  
● Применяется для сохранения данных на стороне клиента (пользователя)

## Cookie
● Браузер должен хранить как минимум 4096 байт кук  
● Минимум 20 шт. на домен  
● Минимум 300 шт. всего  
● Имена не чувствительны к регистру 
Используется для:
● Аутентификация пользователя  
● Хранение настроек пользователя  
● Отслеживание сеанса (сессия)  
● Сбор статистики  
● Проведение экспериментов 

## Cookie (параметры)
● Expires - дата истечения срока действия куки  
● Max-Age - срок действия куки в секундах  
● Domain - домен определяет, где доступен файл куки  
● Path - урл префикс пути, по которому куки будут доступны  
● Secure - куки следует передавать только по HTTPS  
● HttpOnly - запрет на получение куки из JavaScript  
Samesite — сравнительно новый параметр кук, предоставляющий дополнительный контроль над их передачей согласно Origin policy. 
Важно заметить, что данная настройка работает только с secure cookies. 
Возможные значения: Strict, Lax, None.

Cookie (strict)
Cookies с `samesite=strict` никогда не отправятся, если пользователь пришел не с этого же сайта.
Важно помнить, что cookies не будут пересылаться также при навигации высокого уровня (т.е. даже при переходе по ссылке)
Пример: vk.com -> site.com -> cookies не передаются

